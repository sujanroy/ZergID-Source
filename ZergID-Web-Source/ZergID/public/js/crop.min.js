var CROP=function(){
    return function(){
        this.eles={
            ele:undefined,
            container:undefined,
            img:undefined,
            overlay:undefined
        };
        
        this.img=undefined;
        this.imgInfo={
            aw:0,
            ah:0,
            w:0,
            h:0,
            at:0,
            al:0,
            t:0,
            l:0,
            s:1
        };
        
        this.init=function(e){
            this.settings={
                slider:e+" .cropSlider"
                };
                
            var e=$(e+" .cropMain"),t,n,r,i=this;
            n=$("<div />").attr({
                "class":"crop-container"
            }).css({
                width:e.width(),
                height:e.height()
                });
            t=$("<img />").attr({
                "class":"crop-img"
            }).css({
                zIndex:5999,
                top:0,
                left:0
            });
            r=$("<div />").attr({
                "class":"crop-overlay"
            }).css({
                zIndex:6e3
            });
            n.append(r);
            n.append(t);
            e.append(n);
            this.eles.ele=e;
            this.eles.container=n;
            this.eles.img=t;
            this.eles.overlay=r;
            n.resize(function(){
                i.imgSize()
                });
            r.bind(document.ontouchstart!==null?"mousedown":"touchstart",function(e){
                var t=$(this),n={
                    x:e.pageX||e.originalEvent.pageX,
                    y:e.pageY||e.originalEvent.pageY
                    },r={
                    x:t.parent().offset().left,
                    y:t.parent().offset().top
                    };
                    
                e.preventDefault();
                $(document).bind(document.ontouchmove!==null?"mousemove":"touchmove",function(e){
                    if(e.pageX||typeof e.originalEvent.changedTouches[0]!==undefined){
                        var s={
                            x:e.pageX||e.originalEvent.changedTouches[0].pageX,
                            y:e.pageY||e.originalEvent.changedTouches[0].pageY
                            };
                            
                        if(parseInt(t.css("top"))==0){
                            t.css({
                                top:i.eles.ele.offset().top,
                                left:i.eles.ele.offset().left
                                })
                            }
                            i.imgMove({
                            t:parseInt(t.css("top"))-(r.y-(n.y-s.y)),
                            l:parseInt(t.css("left"))-(r.x-(n.x-s.x))
                            });
                        t.css({
                            left:r.x-(n.x-s.x),
                            top:r.y-(n.y-s.y)
                            })
                        }
                    });
            return false
            });
        $(document).bind(document.ontouchend!==null?"mouseup":"touchend",function(e){
            $(document).unbind(document.ontouchmove!==null?"mousemove":"touchmove");
            r.css({
                top:0,
                left:0
            })
            });
        this.slider()
        };
        
    this.loadImg=function(e){
        var t=this;
        this.eles.img.attr("src",e).load(function(){
            t.imgSize()
            })
        };
        
    this.imgSize=function(){
        var e=this.eles.img,t={
            w:e.css("width","").width(),
            h:e.css("height","").height()
            },n=this.eles.container;
        var r={
            wh:this.eles.container.width()/this.eles.container.height(),
            hw:this.eles.container.height()/this.eles.container.width()
            };
            
        this.imgInfo.aw=t.w;
        this.imgInfo.ah=t.h;
        if(t.w*r.hw<t.h*r.wh){
            this.imgInfo.w=n.width()-40*2;
            this.imgInfo.h=this.imgInfo.w*(t.h/t.w);
            this.imgInfo.al=40
            }else{
            this.imgInfo.h=n.height()-40*2;
            this.imgInfo.w=this.imgInfo.h*(t.w/t.h);
            this.imgInfo.at=40
            }
            this.imgResize()
        };
        
    this.imgResize=function(e){
        var t=this.eles.img,n=this.imgInfo,r=n.s;
        n.s=e||n.s;
        t.css({
            width:n.w*n.s,
            height:n.h*n.s
            });
        this.imgMove({
            t:-(n.h*r-n.h*n.s)/2,
            l:-(n.w*r-n.w*n.s)/2
            })
        };
        
    this.imgMove=function(e){
        var t=this.eles.img,n=this.imgInfo,r=this.eles.container;
        n.t+=e.t;
        n.l+=e.l;
        var i=n.at-n.t,s=n.al-n.l;
        if(i>40){
            i=40;
            n.t=n.at==40?0:-40
            }else if(i<-(n.h*n.s-(r.height()-40))){
            i=-(n.h*n.s-(r.height()-40));
            n.t=n.at==40?n.h*n.s-(r.height()-80):n.h*n.s-(r.height()-40)
            }
            if(s>40){
            s=40;
            n.l=n.al==40?0:-40
            }else if(s<-(n.w*n.s-(r.width()-40))){
            s=-(n.w*n.s-(r.width()-40));
            n.l=n.al==40?n.w*n.s-(r.width()-80):n.w*n.s-(r.width()-40)
            }
            t.css({
            top:i,
            left:s
        })
        };
        
    this.slider=function(){
        var e=this;
        $(this.settings.slider).noUiSlider({
            range:[1,4],
            start:1,
            step:.002,
            handles:1,
            slide:function(){
                var t=$(this).val();
                e.imgResize(t)
                }
            })
    };
    
coordinates=function e(t){
    var n=t.imgInfo,r=t.eles.container,i=t.eles.img,s=i.attr("src"),e={
        x:-(parseInt(i.css("left"))-40)*(n.aw/(n.w*n.s)),
        y:-(parseInt(i.css("top"))-40)*(n.ah/(n.h*n.s)),
        w:(r.width()-40*2)*(n.aw/(n.w*n.s)),
        h:(r.height()-40*2)*(n.ah/(n.h*n.s)),
        image:s
    };
    
    return e
    }
}
}();
(function(e){
    e.fn.noUiSlider=function(t,n){
        function r(e,t,n){
            var r=t.data("setup"),i=r.handles;
            t=r.settings;
            r=r.pos;
            e=0>e?0:100<e?100:e;
            2==t.handles&&(n.is(":first-child")?(n=parseFloat(i[1][0].style[r])-t.margin,e=e>n?n:e):(n=parseFloat(i[0][0].style[r])+t.margin,e=e<n?n:e));
            t.step&&(n=o.from(t.range,t.step),e=Math.round(e/n)*n);
            return e
            }
            function i(e){
            try{
                return[e.clientX||e.originalEvent.clientX||e.originalEvent.touches[0].clientX,e.clientY||e.originalEvent.clientY||e.originalEvent.touches[0].clientY]
                }catch(t){
                return["x","y"]
                }
            }
        var s=window.navigator.msPointerEnabled?2:"ontouchend"in document?3:1;
    window.debug&&console&&console.log(s);
    var o={
        to:function(e,t){
            t=0>e[0]?t+Math.abs(e[0]):t-e[0];
            return 100*t/this._length(e)
            },
        from:function(e,t){
            return 100*t/this._length(e)
            },
        is:function(e,t){
            return t*this._length(e)/100+e[0]
            },
        _length:function(e){
            return e[0]>e[1]?e[0]-e[1]:e[1]-e[0]
            }
        },u={
    handles:2,
    serialization:{
        to:["",""],
        resolution:.01
    }
};

methods={
    create:function(){
        return this.each(function(){
            var n=e.extend(u,t),a=e(this).data("_isnS_",!0),l=[],c,h,p="",d=function(e){
                return!isNaN(parseFloat(e))&&isFinite(e)
                },v=(n.serialization.resolution=n.serialization.resolution||.01).toString().split("."),g=1==v[0]?0:v[1].length;
            n.start=d(n.start)?[n.start,0]:n.start;
            e.each(n,function(e,t){
                d(t)?n[e]=parseFloat(t):"object"==typeof t&&d(t[0])&&(t[0]=parseFloat(t[0]),d(t[1])&&(t[1]=parseFloat(t[1])));
                var r=!1;
                t="undefined"==typeof t?"x":t;
                switch(e){
                    case"range":case"start":
                        r=2!=t.length||!d(t[0])||!d(t[1]);
                        break;
                    case"handles":
                        r=1>t||2<t||!d(t);
                        break;
                    case"connect":
                        r="lower"!=t&&"upper"!=t&&"boolean"!=typeof t;
                        break;
                    case"orientation":
                        r="vertical"!=t&&"horizontal"!=t;
                        break;
                    case"margin":case"step":
                        r="undefined"!=typeof t&&!d(t);
                        break;
                    case"serialization":
                        r="object"!=typeof t||!d(t.resolution)||"object"==typeof t.to&&t.to.length<n.handles;
                        break;
                    case"slide":
                        r="function"!=typeof t
                        }
                        r&&console&&console.error("Bad input for "+e+" on slider:",a)
                });
            n.margin=n.margin?o.from(n.range,n.margin):0;
            if(n.serialization.to instanceof jQuery||"string"==typeof n.serialization.to||!1===n.serialization.to)n.serialization.to=[n.serialization.to];
            "vertical"==n.orientation?(p+="vertical",c="top",h=1):(p+="horizontal",c="left",h=0);
            p+=n.connect?"lower"==n.connect?" connect lower":" connect":"";
            a.addClass(p);
            for(p=0;p<n.handles;p++){
                l[p]=a.append("<a><div></div></a>").children(":last");
                v=o.to(n.range,n.start[p]);
                l[p].css(c,v+"%");
                100==v&&l[p].is(":first-child")&&l[p].css("z-index",2);
                var v=(1===s?"mousedown":2===s?"MSPointerDown":"touchstart")+".noUiSliderX",y=(1===s?"mousemove":2===s?"MSPointerMove":"touchmove")+".noUiSlider",b=(1===s?"mouseup":2===s?"MSPointerUp":"touchend")+".noUiSlider";
                l[p].find("div").on(v,function(t){
                    e("body").bind("selectstart.noUiSlider",function(){
                        return!1
                        });
                    if(!a.hasClass("disabled")){
                        e("body").addClass("TOUCH");
                        var s=e(this).addClass("active").parent(),u=s.add(e(document)).add("body"),p=parseFloat(s[0].style[c]),d=i(t),v=d,w=!1;
                        e(document).on(y,function(e){
                            e.preventDefault();
                            e=i(e);
                            if("x"!=e[0]){
                                e[0]-=d[0];
                                e[1]-=d[1];
                                var t=[v[0]!=e[0],v[1]!=e[1]],u=p+100*e[h]/(h?a.height():a.width()),u=r(u,a,s);
                                if(t[h]&&u!=w){
                                    s.css(c,u+"%").data("input").val(o.is(n.range,u).toFixed(g));
                                    var t=n.slide,f=a.data("_n",!0);
                                    "function"===typeof t&&t.call(f,void 0);
                                    w=u;
                                    s.css("z-index",2==l.length&&100==u&&s.is(":first-child")?2:1)
                                    }
                                    v=e
                                }
                            }).on(b,function(){
                        u.off(".noUiSlider");
                        e("body").removeClass("TOUCH");
                        a.find(".active").removeClass("active").end().data("_n")&&a.data("_n",!1).change()
                        })
                    }
                }).on("click",function(e){
                e.stopPropagation()
                })
            }
            if(1==s)a.on("click",function(e){
            if(!a.hasClass("disabled")){
                var t=i(e);
                e=100*(t[h]-a.offset()[c])/(h?a.height():a.width());
                t=1<l.length?t[h]<(l[0].offset()[c]+l[1].offset()[c])/2?l[0]:l[1]:l[0];
                e=r(e,a,t);
                t.css(c,e+"%").data("input").val(o.is(n.range,e).toFixed(g));
                e=n.slide;
                "function"===typeof e&&e.call(a,void 0);
                a.change()
                }
            });
    for(p=0;p<l.length;p++)v=o.is(n.range,parseFloat(l[p][0].style[c])).toFixed(g),"string"==typeof n.serialization.to[p]?l[p].data("input",a.append('<input type="hidden" name="'+n.serialization.to[p]+'">').find("input:last").val(v).change(function(e){
        e.stopPropagation()
        })):!1==n.serialization.to[p]?l[p].data("input",{
        val:function(e){
            if("undefined"!=typeof e)this.handle.data("noUiVal",e);else return this.handle.data("noUiVal")
                },
        handle:l[p]
        }):l[p].data("input",n.serialization.to[p].data("handleNR",p).val(v).change(function(){
        var t=[null,null];
        t[e(this).data("handleNR")]=e(this).val();
        a.val(t)
        }));
    e(this).data("setup",{
        settings:n,
        handles:l,
        pos:c,
        res:g
    })
    })
},
val:function(t){
    if("undefined"!==typeof t){
        var n="number"==typeof t?[t]:t;
        return this.each(function(){
            for(var t=e(this).data("setup"),i=0;i<t.handles.length;i++)if(null!=n[i]){
                var s=r(o.to(t.settings.range,n[i]),e(this),t.handles[i]);
                t.handles[i].css(t.pos,s+"%").data("input").val(o.is(t.settings.range,s).toFixed(t.res))
                }
            })
    }
    t=e(this).data("setup").handles;
for(var i=[],s=0;s<t.length;s++)i.push(parseFloat(t[s].data("input").val()));
return 1==i.length?i[0]:i
},
disabled:function(){
    return n?e(this).addClass("disabled"):e(this).removeClass("disabled")
    }
};

var a=jQuery.fn.val;
jQuery.fn.val=function(){
    return this.data("_isnS_")?methods.val.apply(this,arguments):a.apply(this,arguments)
    };
    
return"disabled"==t?methods.disabled.apply(this):methods.create.apply(this)
}
})(jQuery)